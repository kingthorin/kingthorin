name: Monthly Team Status Update

on:
  workflow_dispatch:
  schedule:
    - cron: '30 0 1 * *'

jobs:
  build:
    name: Monthly Status Update
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
    - name: Setup Action
      uses: actions/checkout@v4
    - name: Create Update
      run: |
        # First day of previous month
        first=$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m-%d)

        # Last day of previous month
        last=$(date -d "$(date +%Y-%m-01) -1 day" +%Y-%m-%d)

        echo $first
        echo $last

        file=index.html

        echo -e "\n" > $file

        commits_team() {
            echo -e "### $1\n" >> $file
            gh search prs --owner zaproxy --owner zapbot --author $2 --created $first..$last --json number,title,url -L 100 --jq '.[] | ("- [#" + (.number|tostring) + "](" + .url + ") " + .title)' >> "$file" 
        }

        commits_contributor() {
           gh pr list --search "-author:kingthorin -author:thc202 -author:psiinon -author:zapbot -author:app/dependabot created:$first..$last" --state all --repo zaproxy/$1 --json author,number,title,url -L 100 --jq '.[] | ("- [#" + (.number|tostring) + "](" + .url + ") " + .title + " â€” From: @" + .author.login)' >> $file
        }

        commits_team "Simon" "psiinon"
        commits_team "Ricardo" "thc202"
        commits_team "Rick" "kingthorin"

        echo -e "\n### Contributors\n" >> $file

        commits_contributor "zaproxy"
        commits_contributor "zap-extensions"
        commits_contributor "zap-core-help"
        commits_contributor "zaproxy-website"
        commits_contributor "community-scripts"

        cat $file >> $GITHUB_STEP_SUMMARY





