name: Weekly Team Status Update

on:
  workflow_dispatch:
  schedule:
    - cron: '00 7 * * TUE'

jobs:
  build:
    name: Weekly Status Update
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
    - name: Setup Action
      uses: actions/checkout@v4
    - name: Create Update
      run: |
        first=$(date -d "last Tuesday" +%Y-%m-%d)
        last=$(date -d "next Tuesday" +%Y-%m-%d)

        # Special case: if today is Tuesday, override "last" to today
        if [ "$(date +%u)" -eq 2 ]; then
            last=$(date +%Y-%m-%d)
        fi
        echo $first
        echo $last

        file=index.md

        echo "" > $file

        commits_team() {
            echo -e "\n### $1\n" >> $file
            gh search prs --owner zaproxy --owner zapbot --author $2 --created $first..$last --json number,title,url -L 100 --jq '.[] | ("- [#" + (.number|tostring) + "](" + .url + ") " + .title)' >> "$file"           
        }

        commits_contributor() {
           gh pr list --search "-author:kingthorin -author:thc202 -author:psiinon -author:ricekot -author:zapbot -author:app/dependabot created:$first..$last" --state all --repo zaproxy/$1 --json author,number,title,url -L 100 --jq '.[] | ("- [#" + (.number|tostring) + "](" + .url + ") " + .title + " â€” From: @" + .author.login)' >> $file
        }
        commits_team "Simon" "psiinon"
        commits_team "Ricardo" "thc202"
        commits_team "Rick" "kingthorin"
        commits_team "Akshath" "ricekot"

        echo -e "\n### Contributors\n" >> $file

        commits_contributor "zaproxy"
        commits_contributor "zap-extensions"
        commits_contributor "zap-core-help"
        commits_contributor "zaproxy-website"
        commits_contributor "community-scripts"

        echo -e "\n" >> $file

        echo '```' >> $GITHUB_STEP_SUMMARY
        cat $file >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY













